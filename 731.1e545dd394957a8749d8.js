"use strict";(self.webpackChunkreact_iztro=self.webpackChunkreact_iztro||[]).push([[724,731],{724:(e,t,n)=>{n.r(t),n.d(t,{default:()=>s});var a=n(6540);const s=({type:e="message",count:t=1,animate:n=!0})=>{const s=()=>a.createElement("div",{className:"skeleton-message"},a.createElement("div",{className:"skeleton-avatar"}),a.createElement("div",{className:"skeleton-content"},a.createElement("div",{className:"skeleton-line skeleton-short"}),a.createElement("div",{className:"skeleton-line"}),a.createElement("div",{className:"skeleton-line skeleton-long"}))),r=()=>a.createElement("div",{className:"skeleton-chat"},a.createElement("div",{className:"skeleton-header"},a.createElement("div",{className:"skeleton-title"}),a.createElement("div",{className:"skeleton-subtitle"})),a.createElement("div",{className:"skeleton-messages"},Array.from({length:3}).map((e,t)=>a.createElement("div",{key:t,className:"skeleton-message-wrapper"},a.createElement("div",{className:"skeleton-message-avatar"}),a.createElement("div",{className:"skeleton-message-content"},a.createElement("div",{className:"skeleton-message-line"}),a.createElement("div",{className:"skeleton-message-line skeleton-short"}))))),a.createElement("div",{className:"skeleton-input"},a.createElement("div",{className:"skeleton-input-field"}),a.createElement("div",{className:"skeleton-input-button"}))),o=()=>a.createElement("div",{className:"skeleton-input-container"},a.createElement("div",{className:"skeleton-input-field"}),a.createElement("div",{className:"skeleton-input-button"}));return a.createElement("div",{className:"skeleton-loader "+(n?"skeleton-animate":"")},(()=>{const n=[];for(let l=0;l<t;l++)switch(e){case"message":default:n.push(a.createElement("div",{key:l},s()));break;case"chat":n.push(a.createElement("div",{key:l},r()));break;case"input":n.push(a.createElement("div",{key:l},o()))}return n})())}},6731:(e,t,n)=>{n.r(t),n.d(t,{default:()=>B});var a=n(6540),s=n(206);const r=()=>/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),o=()=>/Android/i.test(navigator.userAgent),l=()=>{if(!o())return 0;const e=c("bottom"),t=window.screen.height,n=window.innerHeight,a=(window.visualViewport,t-n),s=window.screen.width,r=window.innerWidth,l=Math.abs(s-r);return e>0?e:a>0&&a<=100?a:a>100?0:l>0?48:0},i=()=>{const e=r();return{isMobile:e,headerHeight:e?60:0,keyboardHeight:0,safeAreaTop:c("top"),safeAreaBottom:c("bottom")}},c=e=>{if("undefined"!=typeof CSS&&CSS.supports&&CSS.supports("env","safe-area-inset-top")){const t=getComputedStyle(document.documentElement).getPropertyValue(`env(safe-area-inset-${e})`);return parseInt(t)||0}return 0},m=e=>{if(!(e=>!!e.isMobile&&(window.visualViewport?.height||window.innerHeight)<.75*window.innerHeight)(e))return 0;const t=window.visualViewport?.height||window.innerHeight;return window.innerHeight-t},u=e=>{const t=document.documentElement;t.style.setProperty("--keyboard-height",`${e.keyboardHeight}px`),t.style.setProperty("--safe-area-top",`${e.safeAreaTop}px`),t.style.setProperty("--safe-area-bottom",`${e.safeAreaBottom}px`),t.style.setProperty("--header-height",`${e.headerHeight}px`)},d=()=>{const[e,t]=(0,a.useState)({isVisible:!1,height:0}),n=(0,a.useRef)(r()),s=(0,a.useRef)(o()),i=(0,a.useRef)(l()),c=(0,a.useRef)(null),u=(0,a.useCallback)(e=>{const n=e.keyboardHeight>0;if(t(t=>t.isVisible!==n||t.height!==e.keyboardHeight?{isVisible:n,height:e.keyboardHeight}:t),document.documentElement.style.setProperty("--keyboard-height",`${e.keyboardHeight}px`),s.current){const e=l();i.current=e,document.documentElement.style.setProperty("--android-navigation-bar-height",`${e}px`)}},[]),d=(0,a.useCallback)(((e,t)=>{let n=0;return(...a)=>{const s=Date.now();s-n>=t&&(n=s,e.apply(null,a))}})(()=>{if(!n.current)return;const e=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-top"))||0,t=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-bottom"))||0;let a=0;if(s.current){const e=window.visualViewport?.height||window.innerHeight,t=window.screen.height,n=window.innerHeight,s=l();e<.8*n&&(a=n-e-s),a=Math.max(0,Math.min(a,.5*t))}else a=m({isMobile:!0,headerHeight:60,keyboardHeight:0,safeAreaTop:e,safeAreaBottom:t});u({keyboardHeight:a})},200),[u]),h=(0,a.useCallback)(()=>{n.current&&setTimeout(d,300)},[d]),g=(0,a.useCallback)(()=>{n.current&&setTimeout(()=>{u({keyboardHeight:0})},100)},[u]),p=(0,a.useCallback)(e=>{if(e&&n.current)return e.addEventListener("focus",h),e.addEventListener("blur",g),()=>{e.removeEventListener("focus",h),e.removeEventListener("blur",g)}},[h,g]);return(0,a.useEffect)(()=>{if(n.current)return window.visualViewport?window.visualViewport.addEventListener("resize",d):window.addEventListener("resize",d),c.current=new ResizeObserver(((e,t)=>{let n;return(...a)=>{clearTimeout(n),n=setTimeout(()=>e.apply(null,a),t)}})(d,200)),c.current.observe(document.documentElement),d(),()=>{window.visualViewport?window.visualViewport.removeEventListener("resize",d):window.removeEventListener("resize",d),c.current&&c.current.disconnect()}},[d]),(0,a.useEffect)(()=>{e.isVisible?document.body.classList.add("keyboard-visible"):document.body.classList.remove("keyboard-visible")},[e.isVisible]),(0,a.useEffect)(()=>{if(s.current){document.body.classList.add("android-device");const e=l();i.current=e,document.documentElement.style.setProperty("--android-navigation-bar-height",`${e}px`)}else document.body.classList.remove("android-device")},[]),{keyboardState:e,setupInputListeners:p,hideKeyboard:()=>u({keyboardHeight:0})}},h=e=>e&&0!==e.length?e.join("、"):"无",g=(e,t=new Date,n)=>{if(!e)return"暂无星盘数据";let a=`\n=== 紫微斗数星盘数据 ===\n当前时间：${t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}\n\n基本信息：\n性别：${n}\n阳历日期：${e.solarDate}\n农历日期：${e.lunarDate}\n干支纪年：${e.chineseDate}\n出生时辰：${e.time}（${e.timeRange}）\n星座：${e.sign}\n生肖：${e.zodiac}\n命宫地支：${e.earthlyBranchOfSoulPalace}\n身宫地支：${e.earthlyBranchOfBodyPalace}\n命主：${e.soul}\n身主：${e.body}\n五行局：${e.fiveElementsClass}\n\n十二宫位详情：\n`;if(e.palaces&&e.palaces.length>0&&e.palaces.forEach((e,t)=>{a+=`\n--- 第${t+1}宫 ---\n`,a+=(e=>{const t=e.majorStars?.map(e=>e.name)||[],n=e.minorStars?.map(e=>e.name)||[],a=e.adjectiveStars?.map(e=>e.name)||[];return`\n宫位：${e.name}\n天干地支：${e.heavenlyStem}${e.earthlyBranch}\n主星：${h(t)}\n辅星：${h(n)}\n杂耀：${h(a)}\n长生12神：${e.changsheng12||"无"}\n博士12神：${e.boshi12||"无"}\n将前12神：${e.jiangqian12||"无"}\n岁前12神：${e.suiqian12||"无"}\n大限：${e.decadal?.range?.[0]}-${e.decadal?.range?.[1]}岁\n小限：${e.ages?.join("、")||"无"}\n${e.isBodyPalace?"【身宫】":""}\n${e.isOriginalPalace?"【来因宫】":""}\n  `.trim()})(e),a+="\n\n"}),e.horoscope){const t=e.horoscope();t&&(a+=`\n=== 当前运限信息 ===\n查询日期：${t.solarDate}\n农历日期：${t.lunarDate}\n\n大限：\n天干地支：${t.decadal.heavenlyStem}${t.decadal.earthlyBranch}\n四化星：${h(t.decadal.mutagen||[])}\n\n小限：\n虚岁：${t.age.nominalAge}\n天干地支：${t.age.heavenlyStem}${t.age.earthlyBranch}\n\n流年：\n天干地支：${t.yearly.heavenlyStem}${t.yearly.earthlyBranch}\n四化星：${h(t.yearly.mutagen||[])}\n\n流月：\n天干地支：${t.monthly.heavenlyStem}${t.monthly.earthlyBranch}\n\n流日：\n天干地支：${t.daily.heavenlyStem}${t.daily.earthlyBranch}\n\n流时：\n天干地支：${t.hourly.heavenlyStem}${t.hourly.earthlyBranch}\n`)}return a.trim()},p=(e,t=new Date)=>{if(!e)return"暂无星盘数据";let n=`\n=== 紫微斗数星盘数据（精简版）===\n当前时间：${t.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1})}\n\n基本信息：\n性别：${"male"===e.gender?"男":"女"}\n阳历日期：${e.solarDate}\n干支纪年：${e.chineseDate}\n出生时辰：${e.time}\n命宫地支：${e.earthlyBranchOfSoulPalace}\n身宫地支：${e.earthlyBranchOfBodyPalace}\n命主：${e.soul}\n身主：${e.body}\n五行局：${e.fiveElementsClass}\n\n关键宫位信息：\n`;const a=["命宫","身宫","夫妻宫","事业宫","财帛宫"];if(e.palaces&&e.palaces.length>0&&e.palaces.forEach(e=>{if(a.includes(e.name)){const t=e.majorStars?.map(e=>e.name)||[],a=e.minorStars?.map(e=>e.name)||[];n+=`\n${e.name}：\n天干地支：${e.heavenlyStem}${e.earthlyBranch}\n主星：${t.join("、")||"无"}\n辅星：${a.join("、")||"无"}\n`}}),e.horoscope){const t=e.horoscope();t&&(n+=`\n当前运限：\n大限：${t.decadal.heavenlyStem}${t.decadal.earthlyBranch}\n流年：${t.yearly.heavenlyStem}${t.yearly.earthlyBranch}\n`)}return n.trim()},f=(e,t,n,a,s)=>{const r=new Date,o="你是一位精通古法传承与现代应用的紫微斗数宗师。你的论断不仅基于星盘数据，更融入了深刻的人生智慧。请牢记以下心法：\n1. **天人合一**：星盘是人生命运的蓝图，但人的意志和后天努力同样重要。你的解读应充满智慧和慈悲，旨在帮助问询者“知命而用命”，而非宿命论。\n2. **言必有据**：所有的论断都必须严格依据所提供的星盘数据，结合宫、星、四化进行严谨的逻辑推演。\n3. **结构清晰**：回答应有章法，先有“总论”概括全局，再“分项”详述，最后必须落脚于“建议”，为问询者提供具体、可行的趋吉避凶之道。\n4. **口吻沉稳**：以一位学识渊博、洞察世事的长者口吻进行叙述，语言简练、沉稳、富有哲理。\n\n";if(a&&n){const e=p(n,r),a=p(t,r);return o+`现在，请根据以下两个人的星盘数据，为他们进行专业的“合盘”论断。\n\n第一个人（${s.person1}）的星盘数据：\n${a}\n\n第二个人（${s.person2}）的星盘数据：\n${e}\n\n请运用你的全部学识，特别是“宫位互叠”与“飞星四化”等高级技法，深度剖析二人的缘分本质、互动模式与潜在的共业。你的分析需直指核心，点明关系中的关键，并提供维系与发展的智慧建议。`}return o+`现在，请根据以下用户的星盘数据和当前时间，结合他/她的问题，进行专业的“命盘”解读。\n\n${t?g(t,r,"male"===e?.gender?"男":"女"):"暂无星盘数据"}\n\n请运用你的全部学识，洞察星盘背后的天机，为问询者指点迷津。`},b=(e,t,n)=>{let a="",s=t+e;const r=s.split("\n");s=r.pop()||"";for(const e of r)if(e.startsWith("data: ")){const t=e.slice(6).trim();if("[DONE]"===t)continue;if(!t)continue;try{if(t.startsWith("{")&&t.endsWith("}")){const e=JSON.parse(t);if(e.choices&&e.choices[0].delta&&e.choices[0].delta.content){const t=e.choices[0].delta.content;a+=t,n(t)}}}catch(e){}}return{newBuffer:s,assistantMessage:a}},y=()=>{const{sendRequest:e,isLoading:t,error:n,clearCache:s}=((e={})=>{const{cacheKey:t,cacheTTL:n=3e5,maxRetries:s=2,retryDelay:r=1e3,retryBackoff:o=2}=e,[l,i]=(0,a.useState)(!1),[c,m]=(0,a.useState)(null),u=(0,a.useRef)(null),d=(0,a.useRef)(new Map),h=(0,a.useCallback)(e=>Date.now()-e.timestamp<n,[n]),g=(0,a.useCallback)(e=>{if(!t)return null;const n=`${t}:${e}`,a=d.current.get(n);return a&&h(a)?a.data:null},[t,h]),p=(0,a.useCallback)((e,n)=>{if(!t)return;const a=`${t}:${e}`;d.current.set(a,{data:n,timestamp:Date.now()})},[t]),f=(0,a.useCallback)(()=>{if(!t)return;const e=Array.from(d.current.keys());for(const n of e)n.startsWith(`${t}:`)&&d.current.delete(n)},[t]),b=(0,a.useCallback)(e=>new Promise(t=>setTimeout(t,e)),[]),y=(0,a.useCallback)(async(e,t)=>{const{url:n,options:a={},body:l}=e,c=g(t||n);if(c)return c;u.current&&u.current.abort(),u.current=new AbortController,i(!0),m(null);let d=0,h=r;const f=async()=>{try{const e={...a,signal:u.current?.signal};l&&(e.body=JSON.stringify(l),e.headers||(e.headers={}),e.headers["Content-Type"]="application/json");const s=await fetch(n,e);if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const r=await s.json();return p(t||n,r),r}catch(e){if(e instanceof Error&&"AbortError"===e.name)throw e;if(d++,d>s)throw m(e),e;return await b(h),h*=o,f()}};try{return await f()}finally{i(!1)}},[g,p,r,o,s,b]);return{isLoading:l,error:c,sendRequest:y,cancelRequest:(0,a.useCallback)(()=>{u.current&&(u.current.abort(),u.current=null),i(!1)},[]),clearCache:f}})({cacheKey:"ai-chat",cacheTTL:6e5,maxRetries:3,retryDelay:1e3,retryBackoff:1.5});return{isLoading:t,error:n,sendChatRequest:(0,a.useCallback)(async(t,n={})=>{const a=process.env.VITE_MODEL||"gpt-3.5-turbo",{model:s=a,temperature:r=.7,stream:o=!0}=n;return e({url:"/api/chat",options:{method:"POST",headers:{"Content-Type":"application/json"}},body:{model:s,messages:t,temperature:r,stream:o}},`chat:${JSON.stringify(t.slice(-5))}`)},[e]),clearCache:s}},v=({formData:e,astrolabe:t,synastryAstrolabe:n,isSynastryMode:r=!1,personNames:o={person1:"第一个人",person2:"第二个人"},onMessageUpdate:l,onMessagesChange:i,onLoadingChange:c,onGeneratingChange:m,onStreamingChange:u,onError:d})=>{const[h,g]=(0,a.useState)(!1),p=(0,a.useRef)(null),{model:v}=(0,s.o)(),{sendChatRequest:k,isLoading:E,error:w}=y(),C=(0,a.useCallback)(async(e,t)=>{const n=e.body?.getReader(),a=new TextDecoder;let s="",r="";if(n){u&&u(!0);try{for(;;){const{done:e,value:t}=await n.read();if(e)break;const o=a.decode(t,{stream:!0});r=b(o,r,e=>{s+=e,l(s)}).newBuffer}}catch(e){if(e instanceof Error&&"AbortError"===e.name)return{content:"",shouldUpdate:!1};throw e}r=((e,t)=>{let n="";if(e.trim()){const a=e.split("\n");let s="";for(const e of a)if(e.startsWith("data: ")){const a=e.slice(6).trim();if(a&&"[DONE]"!==a)try{if(a.startsWith("{")&&a.endsWith("}")){const e=JSON.parse(a);if(e.choices&&e.choices[0].delta&&e.choices[0].delta.content){const a=e.choices[0].delta.content;n+=a,t(a)}}}catch(e){}}return s}return e})(r,e=>{s+=e,l(s)}),u&&u(!1)}return{content:s,shouldUpdate:!0}},[l,u]),N=(0,a.useCallback)(async(e,t)=>{const n=process.env.VITE_API_ENDPOINT,a=process.env.VITE_API_KEY;if(!n)throw new Error("VITE_API_ENDPOINT 环境变量未设置");const s=n.endsWith("/chat/completions")?n:`${n}${n.endsWith("/")?"":"/"}chat/completions`,r=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",...a&&{Authorization:`Bearer ${a}`}},body:JSON.stringify({model:t,messages:e,temperature:.7,stream:!0}),signal:p.current?.signal});if(!r.ok)throw new Error(`AI 服务错误: ${r.status} ${r.statusText}`);return r},[]),S=(0,a.useCallback)((e,t,n)=>{const a=[...n];"assistant"!==a[a.length-1]?.role||a[a.length-1]?.content.trim()||a.pop();const s={role:"assistant",content:"抱歉，我在处理您的消息时遇到了问题。请稍后再试。"};a.push(s),i(a),d(!0,t.content)},[i,d]);return{isGenerating:h,sendMessage:(0,a.useCallback)(async(a,s)=>{if(a.content.trim()){c(!0),g(!0),d(!1);try{p.current=new AbortController;const l={role:"assistant",content:""},c=[...s,l];i(c);const m=((e,t,n)=>[{role:"system",content:e},...t,{role:n.role,content:n.content}])(f(e,t??null,n??null,r,o),s,a),u=await N(m,v),{content:d,shouldUpdate:h}=await C(u,s);if(h&&d.trim()){const e=[...s,{role:"assistant",content:d}];i(e)}else i(s)}catch(e){S(e,a,s)}finally{c(!1),g(!1)}}},[t,n,r,o,c,d,N,C,S,i]),regenerateResponse:(0,a.useCallback)(async(a,s)=>{if(a.trim()){d(!1),c(!0),g(!0);try{p.current=new AbortController;const l={role:"assistant",content:""},c=[...s,l];i(c);const m=f(e,t??null,n??null,r,o),u=s.filter(e=>!("assistant"===e.role&&e===s[s.length-1])),d=[{role:"system",content:m},...u,{role:"user",content:a}],h=await N(d,v),{content:g,shouldUpdate:b}=await C(h,s);if(b&&g.trim()){const e=[...u,{role:"assistant",content:g}];i(e)}else i(s)}catch(e){const t={role:"assistant",content:"抱歉，我在处理您的消息时遇到了问题。请稍后再试。"},n=[...s,t];i(n),d(!0,a)}finally{c(!1),g(!1)}}},[t,n,r,o,d,c,N,C,i,v]),stopGeneration:(0,a.useCallback)(()=>{p.current&&(p.current.abort(),p.current=null),g(!1),m(!1),c(!1)},[m,c])}},k=()=>{const[e,t]=(0,a.useState)(i()),[n,s]=(0,a.useState)(!1),o=(0,a.useCallback)(n=>{const a={...e,...n};t(a),u(a)},[e]),l=(0,a.useCallback)(()=>{const e=i();u(e),t(e),s(!0)},[]),c=(0,a.useCallback)(()=>{const e=i();o(e)},[o]),d=(0,a.useCallback)(()=>{e.isMobile&&(document.body.classList.add("mobile-chat"),document.documentElement.style.setProperty("--chat-font-size","16px"))},[e.isMobile]),h=(0,a.useCallback)(()=>{document.body.classList.remove("mobile-chat"),document.documentElement.style.setProperty("--chat-font-size","14px")},[]);(0,a.useEffect)(()=>{if(n)return;l();const t=(a=c,new ResizeObserver(()=>{const e=i();e.keyboardHeight=m(e),u(e),a(e)}));var a;return t.observe(document.documentElement),window.addEventListener("resize",c),e.isMobile?d():h(),()=>{t.disconnect(),window.removeEventListener("resize",c)}},[n,l,c,e.isMobile,d,h]),(0,a.useEffect)(()=>{const t=()=>{const t=r();t!==e.isMobile&&o({isMobile:t})};return window.addEventListener("orientationchange",t),()=>{window.removeEventListener("orientationchange",t)}},[e.isMobile,o]);const g=(0,a.useCallback)(()=>{if(e.isMobile){return document.body.classList.contains("keyboard-visible")?{gridTemplateRows:"\n            var(--header-height)\n            minmax(0, 1fr)\n            var(--keyboard-height)\n            auto\n          "}:{gridTemplateRows:"\n          var(--header-height)\n          minmax(0, 1fr)\n          auto\n        "}}return{gridTemplateRows:"1fr auto"}},[e.isMobile]),p=(0,a.useCallback)(()=>{const t={display:"grid",height:"100%",minHeight:0,overflow:"hidden"};return e.isMobile?{...t,position:"fixed",top:0,left:0,right:0,bottom:0,height:"100dvh",width:"100%",...g()}:{...t,...g()}},[e.isMobile,g]),f=(0,a.useCallback)(()=>{const t={overflowY:"auto",minHeight:0,scrollSnapType:"y proximity"};return e.isMobile?{...t,paddingTop:"var(--safe-area-top)",paddingBottom:"var(--safe-area-bottom)",marginTop:0,marginBottom:0}:{...t,padding:"15px"}},[e.isMobile]),b=(0,a.useCallback)(()=>{const t={flexShrink:0,backgroundColor:"var(--background-color)"};return e.isMobile?{...t,position:"sticky",bottom:0,zIndex:100,paddingBottom:"var(--safe-area-bottom)",borderTop:"1px solid var(--border-color)"}:{...t,padding:"10px"}},[e.isMobile]);return{layoutConfig:e,isInitialized:n,getContainerStyle:p,getMessagesContainerStyle:f,getInputContainerStyle:b,updateLayout:o}};var E=n(7481),w=n(2957),C=n(3867);const N=({src:e,alt:t,className:n="markdown-img",...s})=>{const[r,o]=(0,a.useState)(!1),[l,i]=(0,a.useState)(!1),c=(0,a.useRef)(null);(0,a.useEffect)(()=>{const e=new IntersectionObserver(([t])=>{t.isIntersecting&&(i(!0),e.disconnect())},{rootMargin:"100px",threshold:.1});return c.current&&e.observe(c.current),()=>{c.current&&e.unobserve(c.current)}},[]);return a.createElement("div",{className:"markdown-img-container"},!r&&a.createElement("div",{className:"markdown-img-placeholder"},a.createElement("div",{className:"loading-spinner"})),a.createElement("img",{ref:c,src:l?e:void 0,alt:t,className:`${n} ${r?"loaded":""}`,onLoad:()=>{o(!0)},...s}))},S=a.memo(({content:e})=>{const t=(0,a.useMemo)(()=>e.replace(/\n{3,}/g,"\n\n").replace(/^[\s─]*─{3,}[\s─]*$/gm,"\n\n---\n\n").replace(/^\s+|\s+$/g,""),[e]),n=(0,a.useMemo)(()=>({h1:({children:e,...t})=>a.createElement("h1",{className:"markdown-h1",...t},e),h2:({children:e,...t})=>a.createElement("h2",{className:"markdown-h2",...t},e),h3:({children:e,...t})=>a.createElement("h3",{className:"markdown-h3",...t},e),h4:({children:e,...t})=>a.createElement("h4",{className:"markdown-h4",...t},e),h5:({children:e,...t})=>a.createElement("h5",{className:"markdown-h5",...t},e),h6:({children:e,...t})=>a.createElement("h6",{className:"markdown-h6",...t},e),p:({children:e,...t})=>a.createElement("p",{className:"markdown-p",...t},e),ul:({children:e,...t})=>a.createElement("ul",{className:"markdown-ul",...t},e),ol:({children:e,...t})=>a.createElement("ol",{className:"markdown-ol",...t},e),li:({children:e,...t})=>{const n=a.Children.toArray(e).some(e=>a.isValidElement(e)&&"input"===e.type);return a.createElement("li",{className:"markdown-li "+(n?"task-list-item":""),...t},e)},a:({href:e,children:t,...n})=>a.createElement("a",{href:e,className:"markdown-a",target:"_blank",rel:"noopener noreferrer",...n},t),code:e=>{const{inline:t,className:n,children:s,...r}=e,o=/language-(\w+)/.exec(n||""),l=o?o[1]:"";return!t&&o?a.createElement("div",{className:"markdown-code-wrapper"},a.createElement("div",{className:"markdown-code-header"},a.createElement("span",{className:"markdown-code-language"},l)),a.createElement("code",{className:`markdown-code-block ${n}`,...r},s)):a.createElement("code",{className:"markdown-code-inline",...r},s)},pre:({children:e,...t})=>a.createElement("pre",{className:"markdown-pre",...t},e),blockquote:({children:e,...t})=>a.createElement("blockquote",{className:"markdown-blockquote",...t},e),table:({children:e,...t})=>a.createElement("div",{className:"markdown-table-wrapper"},a.createElement("table",{className:"markdown-table",...t},e)),thead:({children:e,...t})=>a.createElement("thead",{className:"markdown-thead",...t},e),tbody:({children:e,...t})=>a.createElement("tbody",{className:"markdown-tbody",...t},e),tr:({children:e,...t})=>a.createElement("tr",{className:"markdown-tr",...t},e),th:({children:e,...t})=>a.createElement("th",{className:"markdown-th",...t},e),td:({children:e,...t})=>a.createElement("td",{className:"markdown-td",...t},e),strong:({children:e,...t})=>a.createElement("strong",{className:"markdown-strong",...t},e),em:({children:e,...t})=>a.createElement("em",{className:"markdown-em",...t},e),hr:({...e})=>a.createElement("hr",{className:"markdown-hr",...e}),img:({src:e,alt:t,...n})=>a.createElement(N,{src:e,alt:t||"",...n}),del:({children:e,...t})=>a.createElement("del",{className:"markdown-del",...t},e),input:({checked:e,type:t,...n})=>a.createElement("input",{type:"checkbox",checked:e,readOnly:!0,className:"markdown-task-checkbox",...n})}),[]),s=(0,a.useMemo)(()=>a.createElement(E.oz,{remarkPlugins:[w.A,C.A],rehypePlugins:[],components:n},t),[t,n]);return a.createElement("div",{className:"markdown-content"},s)}),$=a.memo(({message:e,isLastMessage:t=!1,showRegenerate:n=!1,onRegenerate:s,messageRef:r,isStreaming:o=!1,showActions:l=!1})=>{const i="user"===e.role,[c,m]=(0,a.useState)(""),[u,d]=(0,a.useState)(!1),h=(0,a.useRef)(null),g=(0,a.useCallback)(()=>{navigator.clipboard.writeText(e.content).then(()=>{}).catch(e=>{})},[e.content]),p=(0,a.useCallback)(()=>{if(navigator.share){const t={title:"紫微斗数AI回复",text:e.content};navigator.share(t).catch(e=>{g()})}else g()},[e.content,g]),f=(0,a.useMemo)(()=>l&&!o&&!i&&u,[l,o,i,u]);return(0,a.useEffect)(()=>{m(e.content),!i&&o&&d(!0)},[e.content,i,o]),a.createElement("div",{ref:r,className:"message-item "+(i?"user-message":"assistant-message")},a.createElement("div",{className:"message-wrapper "+(i?"user-message":"assistant-message")},a.createElement("div",{className:"message-content "+(i?"user-message":"assistant-message")},i?c:a.createElement("div",{ref:h,className:"markdown-content message-markdown"},a.createElement(S,{content:c}))),n&&a.createElement(a.Fragment,null,a.createElement("div",{className:"message-spacer"}),a.createElement("div",{className:"regenerate-container"},a.createElement("button",{className:"regenerate-button quick-action-button",onClick:s,title:"重新生成"},a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},a.createElement("path",{d:"M1 4v6h6"}),a.createElement("path",{d:"M3.51 15a9 9 0 1 0 2.13-9.36L1 10"})),a.createElement("span",null,"重新生成")))),f&&a.createElement(a.Fragment,null,a.createElement("div",{className:"message-spacer"}),a.createElement("div",{className:"message-actions-container"},a.createElement("button",{className:"copy-button",onClick:g,title:"复制","aria-label":"复制"},a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},a.createElement("rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2"}),a.createElement("path",{d:"m4 16c-1.1 0-2-.9-2-2v-10c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"}))),a.createElement("button",{className:"share-button",onClick:p,title:"分享","aria-label":"分享"},a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},a.createElement("circle",{cx:"18",cy:"5",r:"3"}),a.createElement("circle",{cx:"6",cy:"12",r:"3"}),a.createElement("circle",{cx:"18",cy:"19",r:"3"}),a.createElement("line",{x1:"8.59",y1:"13.51",x2:"15.42",y2:"17.49"}),a.createElement("line",{x1:"15.41",y1:"6.51",x2:"8.59",y2:"10.49"})))))))}),M=()=>a.createElement("div",{className:"typing-indicator"},a.createElement("span",{className:"typing-dot"}),a.createElement("span",{className:"typing-dot"}),a.createElement("span",{className:"typing-dot"}));var L=n(724);const x=a.memo(({messages:e,isLoading:t,generationFailed:n,lastFailedMessage:s,onRegenerate:r,messagesContainerRef:o,lastMessageRef:l,isStreaming:i=!1,useMessageStorage:c=!1,useVirtualScroll:m=!1})=>{const u=c?(({maxMessagesInMemory:e=100,pageSize:t=20,storageKey:n="ai-chat-messages"}={})=>{const[s,r]=(0,a.useState)([]),[o,l]=(0,a.useState)([]),[i,c]=(0,a.useState)(1),[m,u]=(0,a.useState)(!1),[d,h]=(0,a.useState)(!0),g=(0,a.useCallback)(()=>{try{const e=localStorage.getItem(n);if(e){const t=JSON.parse(e);if(Array.isArray(t)&&t.every(e=>e&&"object"==typeof e&&("user"===e.role||"assistant"===e.role)&&"string"==typeof e.content))return t}}catch(e){}return[]},[n]),p=(0,a.useCallback)(t=>{try{localStorage.setItem(n,JSON.stringify(t))}catch(a){try{const a=t.slice(-e);localStorage.setItem(n,JSON.stringify(a))}catch(e){}}},[n,e]);(0,a.useEffect)(()=>{const e=g();r(e);const n=e.slice(-t);l(n),c(1),h(e.length>t)},[g,t]);const f=(0,a.useCallback)(t=>{r(n=>{const a=[...n,...t];if(a.length>e){const t=a.slice(-e);return p(t),t}return p(a),a}),l(e=>[...e,...t])},[e,p]),b=(0,a.useCallback)(()=>{!m&&d&&(u(!0),setTimeout(()=>{const e=i+1,n=Math.max(0,s.length-e*t),a=s.length-(e-1)*t;if(n<=0){const e=s.slice(0,a);l(e),h(!1)}else{const t=s.slice(n,a);l(e=>[...t,...e]),c(e)}u(!1)},0))},[s,i,d,m,t]),y=(0,a.useCallback)(()=>{r([]),l([]),c(1),h(!1);try{localStorage.removeItem(n)}catch(e){}},[n]),v=(0,a.useCallback)(()=>{const e=s.slice(-t);l(e),c(1),h(s.length>t)},[s,t]);return{allMessages:s,visibleMessages:o,currentPage:i,isLoading:m,hasMore:d,addMessages:f,loadMoreMessages:b,clearMessages:y,resetToLatest:v}})({maxMessagesInMemory:200,pageSize:30}):null,{visibleMessages:d=e,isLoading:h=!1,hasMore:g=!1,addMessages:p=()=>{},loadMoreMessages:f=()=>{},resetToLatest:b=()=>{}}=u||{},y=c?d:e,v=m?((e,t,n={})=>{const{itemHeight:s=80,overscan:r=5,defaultHeight:o=80}=n,[l,i]=(0,a.useState)(0),[c,m]=(0,a.useState)(0),[u,d]=(0,a.useState)(new Map),[h,g]=(0,a.useState)(!1),p=(0,a.useRef)(null),f=(0,a.useMemo)(()=>{let t=0;for(let n=0;n<e.length;n++){const a=e[n],s=u.get(`${a.role}-${n}`);t+=s?.height||o}return t},[e,u,o]),b=(0,a.useMemo)(()=>{let t=0,n=0,a=e.length;for(let a=0;a<e.length;a++){const s=e[a],i=u.get(`${s.role}-${a}`),c=i?.height||o;if(t+c>l){n=Math.max(0,a-r);break}t+=c}let s=t;for(let t=n;t<e.length;t++){const n=e[t],i=u.get(`${n.role}-${t}`),m=i?.height||o;if(s>l+c){a=Math.min(e.length,t+r);break}s+=m}return{startIndex:n,endIndex:a,startOffset:t}},[e,l,c,u,o,r]),y=(0,a.useCallback)((t,n)=>{d(a=>{const s=new Map(a),r=s.get(t);if(!r||r.height!==n){s.set(t,{id:t,height:n,offset:r?.offset||0});let a=0;for(let t=0;t<e.length;t++){const n=`${e[t].role}-${t}`,r=s.get(n);r?(s.set(n,{...r,offset:a}),a+=r.height):a+=o}}return s})},[e,o]),v=(0,a.useCallback)(()=>{t.current&&(i(t.current.scrollTop),g(!0),p.current&&clearTimeout(p.current),p.current=setTimeout(()=>{g(!1)},150))},[t]);(0,a.useEffect)(()=>{const e=()=>{t.current&&m(t.current.clientHeight)};return e(),window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e),p.current&&clearTimeout(p.current)}},[t]),(0,a.useEffect)(()=>{const e=t.current;if(e)return e.addEventListener("scroll",v,{passive:!0}),()=>{e.removeEventListener("scroll",v)}},[t,v]);const k=(0,a.useMemo)(()=>{const t=[];let n=0;for(let a=0;a<e.length;a++){const s=e[a],r=u.get(`${s.role}-${a}`),l=r?.height||o;a>=b.startIndex&&a<b.endIndex&&t.push({item:s,index:a,offset:n,height:l}),n+=l}return t},[e,u,b,o]),E=(0,a.useCallback)(n=>{if(t.current){let a=0;for(let t=0;t<n&&t<e.length;t++){const n=u.get(`${e[t].role}-${t}`);a+=n?.height||o}t.current.scrollTo({top:a,behavior:"smooth"})}},[t,e,u,o]),w=(0,a.useCallback)(()=>{t.current&&t.current.scrollTo({top:f,behavior:"smooth"})},[t,f]);return{visibleItems:k,totalHeight:f,isScrolling:h,measureItem:y,scrollToIndex:E,scrollToBottom:w,scrollTop:l}})(y,o,{itemHeight:80,overscan:3,defaultHeight:80}):null,{visibleItems:k=[],totalHeight:E=0,isScrolling:w=!1,measureItem:C=()=>{},scrollToIndex:N=()=>{},scrollToBottom:S=()=>{}}=v||{};(0,a.useEffect)(()=>{if(c&&e.length>0){const t=d[d.length-1]?e.filter(e=>!d.some(t=>t.role===e.role&&t.content===e.content)):e;t.length>0&&p(t)}},[e,d,c,p]);const x=(0,a.useRef)(null);(0,a.useEffect)(()=>{if(!c||!g||h)return;const e=new IntersectionObserver(e=>{e[0].isIntersecting&&f()},{root:o.current,threshold:.1,rootMargin:"100px"});return x.current&&e.observe(x.current),()=>{x.current&&e.unobserve(x.current)}},[c,g,h,f,o]),(0,a.useEffect)(()=>{!w&&y.length>0&&S()},[y.length,w,S]);const T=(0,a.useMemo)(()=>m?k.map(({item:e,index:t,offset:s,height:o})=>{const c=y.indexOf(e),m=c===y.length-1;return a.createElement("div",{key:`${e.role}-${c}-${e.content.slice(0,20)}`,className:"message-item-container",style:{position:"absolute",top:s,left:0,right:0,height:o||"auto"},ref:t=>{if(t){const n=t.getBoundingClientRect().height;C(`${e.role}-${c}`,n)}}},a.createElement($,{message:e,isLastMessage:m,showRegenerate:n&&"assistant"===e.role&&m,onRegenerate:r,messageRef:m?l:void 0,isStreaming:i&&m&&"assistant"===e.role,showActions:"assistant"===e.role&&m&&!i}))}):y.map((e,t)=>{const s=t===y.length-1;return a.createElement($,{key:`${e.role}-${t}-${e.content.slice(0,20)}`,message:e,isLastMessage:s,showRegenerate:n&&"assistant"===e.role&&s,onRegenerate:r,messageRef:s?l:void 0,isStreaming:i&&s&&"assistant"===e.role,showActions:"assistant"===e.role&&s&&!i})}),[y,k,m,t,n,i,r,l,C]);return a.createElement("div",{ref:o,className:"chat-messages"},m&&a.createElement("div",{className:"virtual-scroll-container"},T),!m&&a.createElement(a.Fragment,null,c&&g&&a.createElement("div",{ref:x,className:"load-more-trigger"},h?"加载中...":"向上滚动加载更多消息"),T),t&&a.createElement("div",{className:"message assistant-message"},a.createElement(M,null)),(h||t&&0===y.length)&&a.createElement("div",{className:"chat-skeleton-fallback"},a.createElement(L.default,{type:"message",count:3,animate:!0})),a.createElement("div",{ref:l,className:"bottom-observer"}))}),T=a.memo(({inputValue:e,onInputChange:t,onSubmit:n,onToggleQuestionPanel:s,onStopGeneration:r,isGenerating:o,isLoading:l,showQuestionPanel:i,inputRef:c,setupInputListeners:m})=>{const[u,d]=(0,a.useState)(!1),[h,g]=(0,a.useState)(!1),[p,f]=(0,a.useState)(!1),[b,y]=(0,a.useState)(0),[v,k]=(0,a.useState)(0),E=(0,a.useMemo)(()=>({isIOSDevice:/iPhone|iPad|iPod/i.test(navigator.userAgent),isAndroidDevice:/Android/i.test(navigator.userAgent),isStandalone:window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone||document.referrer.includes("android-app://")}),[]),w=(0,a.useMemo)(()=>({iosNotchHeight:(()=>{if(!E.isIOSDevice)return 0;const e=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-top"))||0;return e>0?Math.max(e,20):0})(),androidNavBarHeight:(()=>{if(!E.isAndroidDevice)return 0;const e=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-bottom"))||0,t=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--android-navigation-bar-height"))||0;return Math.max(e,t)})()}),[E]),C=(0,a.useCallback)(e=>{t(e.target.value)},[t]),N=(0,a.useCallback)(()=>{o?r():e.trim()?n(new Event("submit")):s()},[o,e,r,n,s]);return(0,a.useEffect)(()=>{d(E.isStandalone),g(E.isIOSDevice),f(E.isAndroidDevice),k(w.iosNotchHeight),y(w.androidNavBarHeight)},[E,w]),(0,a.useEffect)(()=>{const e=window.matchMedia("(display-mode: standalone)"),t=()=>d(e.matches);e.addEventListener("change",t);const n=new MutationObserver(()=>{if(E.isAndroidDevice){const e=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-bottom"))||0,t=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--android-navigation-bar-height"))||0;y(Math.max(e,t))}});return n.observe(document.documentElement,{attributes:!0,attributeFilter:["style"]}),()=>{e.removeEventListener("change",t),n.disconnect()}},[E]),(0,a.useEffect)(()=>{c.current&&m(c.current)},[c,m]),a.createElement("form",{className:`chat-input chat-input-form ${u?"pwa-mode":""} ${h?"ios-mode":""} ${p?"android-mode":""}`,onSubmit:n},a.createElement("input",{ref:c,type:"text",value:e,onChange:C,placeholder:"输入您的问题...",disabled:l,className:"chat-input-field"}),a.createElement("button",{type:o?"button":e.trim()?"submit":"button",onClick:N,disabled:l&&!o,className:"chat-action-button chat-send-button"},o?a.createElement("span",{className:"chat-stop-icon"},"■"):e.trim()?a.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"#ffffff",stroke:"#ffffff",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"chat-send-icon"},a.createElement("line",{x1:"22",y1:"2",x2:"11",y2:"13"}),a.createElement("polygon",{points:"22 2 15 22 11 13 2 9 22 2"})):a.createElement("span",{className:"chat-toggle-icon"},i?"✕":"+")))}),R=({model:e,setModel:t,models:n})=>{const[s,r]=(0,a.useState)(!1),o=(0,a.useRef)(null);return(0,a.useEffect)(()=>{const e=e=>{o.current&&!o.current.contains(e.target)&&r(!1)};return document.addEventListener("mousedown",e),()=>{document.removeEventListener("mousedown",e)}},[]),(0,a.useEffect)(()=>{s?document.body.classList.add("model-selector-open"):document.body.classList.remove("model-selector-open")},[s]),a.createElement("div",{className:"model-selector-container",ref:o},a.createElement("button",{className:"quick-action-button",onClick:()=>r(!s)},a.createElement("svg",{width:"18",height:"18",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},a.createElement("path",{d:"M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}))),s&&a.createElement("ul",{className:"model-selector-list"},n.map(n=>a.createElement("li",{key:n,onClick:()=>(t(n),void r(!1)),className:e===n?"active":""},n))))},I=({quickActions:e,onQuickActionClick:t,isLoading:n,model:s,setModel:r,models:o})=>a.createElement("div",{className:"quick-actions-container"},a.createElement("div",{className:"quick-actions"},a.createElement(R,{model:s,setModel:r,models:o}),e.map(e=>a.createElement("button",{key:e.id,className:"quick-action-button",onClick:()=>t(e.name,e.prompt),disabled:n},e.name)))),A=({questionCategories:e,activeQuestionTab:t,onTabChange:n,onQuestionClick:s,showQuestionPanel:r})=>{if(!r)return null;const o=e.find(e=>e.name===t);return a.createElement("div",{className:"question-panel"},a.createElement("div",{className:"question-tabs"},e.map(e=>a.createElement("button",{key:e.name,className:"tab-button question-tab-button "+(t===e.name?"active":""),onClick:()=>n(e.name)},e.name))),a.createElement("div",{className:"question-content"},o?.subCategories.map(e=>a.createElement("div",{key:e.name,className:"question-group"},a.createElement("h4",{className:"category-heading"},e.name),a.createElement("div",{className:"questions-wrapper"},e.questions.map((e,t)=>a.createElement("p",{key:t,onClick:()=>s(e),className:"question-text"},e)))))))},P=a.memo(({isVisible:e,onClick:t})=>e?a.createElement("button",{className:"scroll-to-bottom-button "+(e?"visible":""),onClick:t,"aria-label":"滚动到底部"},a.createElement("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},a.createElement("polyline",{points:"6 9 12 15 18 9"}))):null),B=a.memo(({formData:e,astrolabe:t,synastryAstrolabe:r,isSynastryMode:o=!1,personNames:l={person1:"第一个人",person2:"第二个人"},isVisible:i=!0})=>{const{activeSession:c,setMessages:m,isLoading:u,setIsLoading:h,updateLastMessage:g,updateSessionTitle:p,model:f,setModel:b}=(0,s.o)(),y=(0,a.useMemo)(()=>c?.messages??[],[c]),[E,w]=(0,a.useState)(""),[C,N]=(0,a.useState)(!1),[S,$]=(0,a.useState)(!1),[M,R]=(0,a.useState)(!1),[B,H]=(0,a.useState)(!1),[V,q]=(0,a.useState)(""),[D,O]=(0,a.useState)("感情"),z=a.useRef(null),[j,W]=(0,a.useState)([]),[Q,U]=(0,a.useState)([]),[F,_]=(0,a.useState)([]),[G,J]=(0,a.useState)(!1),{messagesContainerRef:K,lastMessageRef:Y,userScrolledUp:X,setUserScrolledUp:Z,scrollToBottom:ee}=((e,t,n=!1)=>{const[s,r]=(0,a.useState)(!1),[o,l]=(0,a.useState)(!1),i=(0,a.useRef)(null),c=(0,a.useRef)(null),m=(0,a.useRef)(null),u=(0,a.useRef)(null),d=(0,a.useRef)(null),h=(0,a.useCallback)(()=>{const e=i.current;if(!e)return!0;const{scrollTop:t,scrollHeight:n,clientHeight:a}=e;return n-t<=a+100},[]),g=(0,a.useCallback)((e=!1)=>{if(!t)return;if((o||s)&&!e)return;const n=i.current;n&&requestAnimationFrame(()=>{n.scrollTo({top:n.scrollHeight,behavior:e?"auto":"smooth"}),e&&setTimeout(()=>{n.scrollTo({top:n.scrollHeight,behavior:"auto"})},50)})},[t,s,o]),p=(0,a.useCallback)(()=>{u.current&&clearTimeout(u.current),d.current&&clearTimeout(d.current),l(!0),u.current=setTimeout(()=>{const e=h();r(!e),d.current=setTimeout(()=>{l(!1)},1500)},150)},[h]);(0,a.useEffect)(()=>{if(t)return m.current=new IntersectionObserver(([e])=>{e.isIntersecting&&(r(!1),l(!1))},{root:i.current,threshold:.1}),c.current&&m.current.observe(c.current),()=>{m.current&&m.current.disconnect()}},[t,e.length]),(0,a.useEffect)(()=>{const e=i.current;if(e&&t)return e.addEventListener("scroll",p,{passive:!0}),()=>{e.removeEventListener("scroll",p),u.current&&clearTimeout(u.current),d.current&&clearTimeout(d.current)}},[t,p]),(0,a.useEffect)(()=>{0!==e.length&&("user"===e[e.length-1].role?(r(!1),l(!1),setTimeout(()=>g(!0),100)):s||o||g())},[e,s,o,g]),(0,a.useEffect)(()=>{!t||s||o||g()},[t,s,o,g]),(0,a.useEffect)(()=>{n||l(!1)},[n]);const f=(0,a.useCallback)(()=>{r(!1),l(!1),g(!0)},[g]);return{messagesContainerRef:i,lastMessageRef:c,userScrolledUp:s,setUserScrolledUp:r,scrollToBottom:g,resetScrollState:f}})(y,i,M),{keyboardState:te,setupInputListeners:ne}=d(),{getContainerStyle:ae,getMessagesContainerStyle:se,getInputContainerStyle:re}=k(),{sendMessage:oe,regenerateResponse:le,stopGeneration:ie}=v({formData:e,astrolabe:t,synastryAstrolabe:r,isSynastryMode:o,personNames:l,onMessageUpdate:g,onMessagesChange:m,onLoadingChange:h,onGeneratingChange:$,onStreamingChange:R,onError:(e,t)=>{H(e),t&&q(t)}});(0,a.useEffect)(()=>{if(c&&"新的对话"===c.title&&c.messages.length>=2&&"user"===c.messages[0].role){const e=c.messages[0].content.substring(0,20);p(c.id,e)}},[c,p]),(0,a.useEffect)(()=>{(async()=>{try{const{quickActions:e,synastryQuickActions:t,questionCategories:a}=await n.e(13).then(n.bind(n,4013));W(e),U(t),_(a),J(!0)}catch(e){J(!0)}})()},[]),(0,a.useEffect)(()=>{te.isVisible&&C&&N(!1)},[te.isVisible,C]);const ce=(0,a.useCallback)(async e=>{if(!e.trim()||u)return;const t={role:"user",content:e},n=[...y,t];m(n),w(""),H(!1),q(e),N(!1),await oe(t,n)},[u,y,oe,m]),me=(0,a.useCallback)(async(e,t)=>{if(!e.trim()||u)return;const n={role:"user",content:e},a=[...y,n];m(a),w(""),H(!1),q(e),N(!1),await oe({...n,content:t},a)},[u,y,oe,m]),ue=(0,a.useCallback)(e=>{ce(e)},[ce]),de=(0,a.useCallback)(e=>{e.preventDefault(),ce(E)},[ce,E]),he=(0,a.useCallback)(()=>{N(!C)},[C]),ge=(0,a.useCallback)(async()=>{V.trim()&&(H(!1),await le(V,y))},[V,y,le]);(0,a.useCallback)(()=>{C&&N(!1)},[C]);return i?a.createElement("div",{className:"ai-chat "+(i?"visible":"hidden")},a.createElement(x,{messages:y,isLoading:u,generationFailed:B,lastFailedMessage:V,onRegenerate:ge,messagesContainerRef:K,lastMessageRef:Y,isStreaming:M}),a.createElement("div",{className:"chat-input-container",onClick:e=>e.stopPropagation()},G?a.createElement(a.Fragment,null,a.createElement(I,{quickActions:o?Q:j,onQuickActionClick:me,isLoading:u,model:f,setModel:b,models:["sydf/v1-250520","qwen/qwen3-max","ovo/deepseek-v3.1","ovo/glm-4.5","ovo/kimi-k2-0905","ovo/gemini-2.5-pro","ovo/gpt-oss-120","ovo/llama-v4-maverick"]}),a.createElement(T,{inputValue:E,onInputChange:w,onSubmit:de,onToggleQuestionPanel:he,onStopGeneration:ie,isGenerating:S,isLoading:u,showQuestionPanel:C,inputRef:z,setupInputListeners:ne}),a.createElement(A,{questionCategories:F,activeQuestionTab:D,onTabChange:O,onQuestionClick:ue,showQuestionPanel:C})):a.createElement("div",{className:"chat-skeleton-fallback"},a.createElement(L.default,{type:"input",animate:!0}))),a.createElement(P,{isVisible:X&&(M||u),onClick:()=>{ee(!0),Z(!1)}})):null})}}]);